name: Deploy CloudFormation Stacks

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  id-token: write # This is required for requesting the JWT
  contents: read # This is required for actions/checkout

jobs:
  check-secret:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        role-to-assume: ${{ secrets.cloudformation_role_arn }}
        aws-region: ${{ secrets.aws_region }}
    # The following will fail with the error `Error: ResourceNotFoundException: Secrets Manager can't find the specified secret..` if it does not exist.
    - name: Check Secrets Exist in AWS
      uses: aws-actions/aws-secretsmanager-get-secrets@v2
      with:
        secret-ids: instagram_token
    - name: Deploy S3 Bucket for lambda functions
      id: deploy-s3
      uses: aws-actions/aws-cloudformation-github-deploy@v1
      with:
        name: LambdaFunctionsBucket
        template: cloudformation/S3Bucket.yml
        no-fail-on-empty-changeset: "1"
        capabilities: CAPABILITY_IAM,CAPABILITY_NAMED_IAM
    - name: S3 Bucket ARN
      run: echo ${{ steps.deploy-s3.outputs['BucketARN'] }}
    # - name: Deploy code to S3
    #   run: aws s3 sync ./scripts/ s3://${{ vars.S3_TEMPLATES_BUCKET_NAME }} --delete

    # - name: Deploy template to AWS CloudFormation
    #   uses: aws-actions/aws-cloudformation-github-deploy@v1
    #   with:
    #     name: AddInstagramUser
    #     template: cloudformation/AddInstagramUser.yml
    #     no-fail-on-empty-changeset: "1"
    #     capabilities: CAPABILITY_IAM,CAPABILITY_NAMED_IAM
